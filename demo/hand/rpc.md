# rpc

目的，熟悉netty，熟悉rpc的过程。

代码正在重新整理，预计整理计划会排到7月份吧。目前放的是需要本身去调整设置的代码，不能说直接加入就能使用。

## 理解Rpc?

Remote Procedure Call

远程服务调用，本地服务调用，可以有很多种方式，可以看作进程通信也行。里面有一个过程是可以通过socket进行通信。

rpc本身做的事情很清晰，但是具体实施起来需要进行协约与规定，也就是rpc协议，在这种思想下进行调用。而如果每次socket调用都需要去关注连接，解析，返回等过程，负担很大。有一种行为非常适合此种情况，代理设计模式。

在Aop中，也体现了屏蔽细节，用户无关等特性。而rpc想做的是服务调用，屏蔽掉远程的细节，让服务调用者只关心调用过程即可。而Rpc框架相当于在以下的事情。

1. 中心服务发现。
2. 中心服务注册。
3. 使用远程对象调用函数。
4. 远程对象实际调用函数。
5. 调用方包装。
6. 提供方包装。



### 注册中心

发现与注册通过在v 1.0版本使用redis。

在v1.1版本使用了更加可靠的zookeeper。



### 调用方

服务请求者，会首先取得一个调用方接口。

然后使用ioc装入，动态代理后对象。

动态代理：请求服务中心，关于该服务的ip与端口，然后序列化请求，发给服务提供方，底层使用netty。



### 提供方

提供者会生成一个自身的id，然后服务中心放id，然后根据id去寻找有没有ip，没有就说明服务g了。

动态代理：将对应的接口进行实例化，并且执行调用的过程，接受与返回结构都使用netty为底层。



------

update 最近面试一场后，发现自己对RPC的意义，以及与HTTP的不同说不清楚，总结反思下，也就是对于为什么这个问题不深入，所以至此在继续收集资料学习下，为什么RPC。



## 为什么RPC

其实，我复盘了下我的面试，我在回答这个问题的时候，讲了很多的RPC的细节是什么，我对于RPC部分的抽象思考需要加深，回答细节感觉上是对自己并不自信的表现，今后回答问题或者描述过程，尽量给出1层次描述，而不是直接细节描述了。

1. RPC是一种思想，远程服务调用。

2. 他与HTTP不同，不是协议是想法。
3. HTTP协议应该和RPC协议进行比较。



可以用RPC的地方一般都可以用HTTP，所以从这个角度出发，目标弄清楚2个问题。

1. HTTP与RPC的区别。
2. 有了HTTP为什么还需要RPC.



### 先来了解RPC是什么

不罗嗦，就是远程服务调用。那么本地服务调用关心的是，函数的地址，参数，返回值。所以同理如果要实现远程服务调用，你需要直到另外一个机器上，函数的地址，参数，返回值。这个应该可以做到，可以使用映射储存一个对应的符号引用，然后在另外的机器上，做到转化为直接引用。



那接下来需要关心下具体的细节了。首先第一个问题，抽离本质，RPC在端设备上通信，必然需要走计算机网络通信那块的内容。我理解中所谓的计算机网络，只不过是套娃罢了，谁规定只能4，5，7层协议，我套100层行不行？



正常来说协议是IP套TCP，TCP套HTTP，HTTP内包含传输的数据。那么HTTP其实也可以在套一层，规定俗称的内容，我继续套娃也没问题，但是没必要。从计算机网络的结构来说，其实我觉得到了应用层前，都是没必要去争论的，毕竟目前一时半会也没有谁想去修改这些部分。



**总结**

过程分解

1. 包装网络包，内容包含函数，地址，需要的返回值。
2. 通信且等待结果。
3. 找到函数内存地址。
4. 使用参数，调用函数地址。
5. 返回结果。
6. 通信。
7. 收回结果。

### RPC协议？

你肯定没有见过谁给出准确公认的RPC协议，并不能像HTTP那样谁都支持，所以说RPC的协议更准确。我可以叫OSZN协议，只要承认这个协议的人，都可以进行通信，所以激发了我对应用层的思考。同样是通信协议，为什么HTTP那么多人承认，而RPC的协议并没有一个公认的格式。

这就是涉及一个公共需求的问题了，HTTP的出发点是B/S架构，也就是说其中的一个端设备的应用程序是浏览器。HTTP协议为了应对用户，浏览器，服务器相关需求，变得日益的膨胀。它的**通用性**是牺牲了非常多的空间去实现的。所以在现代网络中，即使有些服务不需要面对浏览器与用户，只是服务器与服务器之间的交互，但基于HTTP协议，仍然需要继续兼容哪些部分。但这任然不是问题，只是一个优点与缺点，而对于场景来说，才能说才存在问题。

那么，对于追求更加精简与效率的通信来说，这其中就会有可以提升的空间，因为HTTP面向的角色过多，在高性能与通用性上，选择了通用性。那么我们可以牺牲掉通用性换取高性能的通信方式。所以RPC一大优点是**面向服务进行优化**。第一步，直接讲HTTP繁重的字段进行精简，减少包的长度。我在过分点，每个具体的服务，直接使用具体的协议，极大的牺牲通用性，面向结果编程，速度肯定能快的（有用但没必要）。

Rest风格的HTTP请求，其实完全可以做到RPC的相关内容，RPC只是远程服务调用，不要被所谓的形势所掩盖了本质，我只需要做到调用远程服务和本地一样就行，那么即使调用的是HTTP请求，使用的URL，但是仍然能定位到其他设备上的对应函数，也是RPC。



### RPC框架

对应上诉的总结来说，具体的RPC实现如下。



![img](https://static001.geekbang.org/infoq/17/17dffc912301f96a0d2c7b6f55255365.png)

但其中有一点是现在分布式条件下，一个服务需要做到多台设备支撑。所以现代的RPC一般会使用到一个服务的中心的概念，而HTTP由于协议的固定，这个事情只能通过部分去做，例如网关。而RPC这个工作，可以直接交给自己的RPC服务中心去做，也就是注册中心，提供服务的注册与发现功能。同时RPC本地存根可以做到负载均衡，熔断降级等功能。



### 总结

HTTP牺牲了性能，选择通用性，被更多的人所承认。  

RPC选择了性能，可以针对相对的服务进行优化，而且更适用于现代分布式场景。

RPC并不是协议，而是一个简单的远程服务调用，但他衍生出了RPC的一个框架，以及RPC的通信协议。



推荐阅读

https://grpc.io/docs/what-is-grpc/introduction/

https://cn.dubbo.apache.org/zh-cn/index.html

https://www.zhihu.com/question/41609070

https://zh.wikipedia.org/zh-sg/HTTP/2

https://zhuanlan.zhihu.com/p/137586040
